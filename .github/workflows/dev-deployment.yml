name: Dev deployment
on:
  pull_request:
    branches:
      - master
jobs:
  deploy_backend:
    runs-on: ubuntu-latest
    environment: development
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: dev
      - name: Overwrite appsettings.json
        uses: microsoft/variable-substitution@v1
        with:
          files: Api/appsettings.json
        env:
          AppSettings.ConnectionStrings.DefaultConnection: ${{ secrets.DB_CONNECTION_STRING }}
      - name: Set up .NET
        uses: actions/setup-dotnet@v2
        with:
          dotnet-version: "6.0"
      - name: Build
        run: dotnet build -c Release -o ./app/build F-Hostel.sln
      - name: Publish
        run: dotnet publish -c Release -o ./app/publish
      - name: Copy to vps
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          source: ./app/publish/**
          target: /home/${{ secrets.USERNAME }}/
      - name: Run
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          script_stop: true
          script: |
            cd /home/${{ secrets.USERNAME }}/app/publish
            screen -ls 2>&1 | grep '(Detached)' | grep -o 'server' | xargs -I{} -n 1 -r screen -r -S {} -X quit
            screen -S server -dm sudo dotnet Api.dll --urls http://0.0.0.0:${{ secrets.BACKEND_PORT }}
            sleep 5
            screen -ls 2>&1 | grep '(Detached)' | grep -F -w 'server'
